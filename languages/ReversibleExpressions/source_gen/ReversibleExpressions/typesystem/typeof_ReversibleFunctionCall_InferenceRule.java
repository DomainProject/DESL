package ReversibleExpressions.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.runtime.AbstractInferenceRule_Runtime;
import jetbrains.mps.lang.typesystem.runtime.InferenceRule_Runtime;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.lang.typesystem.runtime.IsApplicableStatus;
import java.util.List;
import ReversibleExpressions.behavior.ReversibleFunctionCall__BehaviorDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.errors.messageTargets.MessageTarget;
import jetbrains.mps.errors.messageTargets.NodeMessageTarget;
import jetbrains.mps.errors.IErrorReporter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.typesystem.inference.EquationInfo;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SInterfaceConcept;
import org.jetbrains.mps.openapi.language.SConcept;

public class typeof_ReversibleFunctionCall_InferenceRule extends AbstractInferenceRule_Runtime implements InferenceRule_Runtime {
  public typeof_ReversibleFunctionCall_InferenceRule() {
  }
  public void applyRule(final SNode call, final TypeCheckingContext typeCheckingContext, IsApplicableStatus status) {
    final List<SNode> formals = ReversibleFunctionCall__BehaviorDescriptor.getFormals_id2TIMRpJob12.invoke(call);
    final List<SNode> actuals = ReversibleFunctionCall__BehaviorDescriptor.getActuals_id2TIMRpJodKn.invoke(call);
    final int formalCount = ListSequence.fromList(formals).count();
    final int actualCount = ListSequence.fromList(actuals).count();
    if ((!((boolean) ReversibleFunctionCall__BehaviorDescriptor.hasEllipsis_id2TIMRpJok1r.invoke(call)) && formalCount != actualCount) || ((boolean) ReversibleFunctionCall__BehaviorDescriptor.hasEllipsis_id2TIMRpJok1r.invoke(call) && actualCount < formalCount)) {
      {
        final MessageTarget errorTarget = new NodeMessageTarget();
        IErrorReporter _reporter_2309309498 = typeCheckingContext.reportTypeError(call, "wrong number of arguments, expected: " + ListSequence.fromList(SLinkOperations.getChildren(ReversibleFunctionCall__BehaviorDescriptor.getFunction_id2TIMRpJnWr_.invoke(call), LINKS.arguments$gPkY)).count(), "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "688756255682717084", null, errorTarget);
      }
    } else {
      final int smaller = Math.min(actualCount, formalCount);

      if (smaller == 0) {
        {
          final SNode returnType = typeCheckingContext.typeOf(ReversibleFunctionCall__BehaviorDescriptor.getReturnType_id2TIMRpJoBIg.invoke(call), "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "4038282106533053686", true);
          typeCheckingContext.whenConcrete(returnType, () -> {
            {
              SNode _nodeToCheck_1029348928467 = call;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "205952376338698569", 0, null);
              typeCheckingContext.createGreaterThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "205952376338698572", true), (SNode) typeCheckingContext.getExpandedNode(returnType), false, true, _info_12389875345);
            }
          }, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "4038282106533053678", false, false);
        }
      } else {
        for (int i = smaller - 1; i >= 0; i--) {
          final int actualIndex = i;
          final boolean isLastOne = (actualIndex == 0);

          {
            final SNode actualType = typeCheckingContext.typeOf(ListSequence.fromList(actuals).getElement(actualIndex), "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "4038282106532667892", true);
            typeCheckingContext.whenConcrete(actualType, () -> {
              final SNode formal = ListSequence.fromList(formals).getElement(actualIndex);
              final SNode actual = ListSequence.fromList(actuals).getElement(actualIndex);

              if (!(SNodeOperations.isInstanceOf(actual, CONCEPTS.IRequiresTypeToBeInferred$3C))) {
                if (!(typeCheckingContext.isSingleTypeComputation())) {
                  {
                    SNode _nodeToCheck_1029348928467 = actual;
                    EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "9116549269032603465", 0, null);
                    typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(actual, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "9116549269032603467", true), (SNode) typeCheckingContext.typeOf(formal, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "9116549269032603470", true), true, true, _info_12389875345);
                  }
                }
              }

              // add when_concrete on the returnType after the last argument type is known
              if (isLastOne) {
                {
                  final SNode returnType = typeCheckingContext.typeOf(ReversibleFunctionCall__BehaviorDescriptor.getReturnType_id2TIMRpJoBIg.invoke(call), "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "182845728207646093", true);
                  typeCheckingContext.whenConcrete(returnType, () -> {
                    {
                      SNode _nodeToCheck_1029348928467 = call;
                      EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "9116549269035493087", 0, null);
                      typeCheckingContext.createGreaterThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "9116549269035493090", true), (SNode) typeCheckingContext.getExpandedNode(returnType), false, true, _info_12389875345);
                    }
                  }, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "182845728207645191", false, false);
                }
              }
            }, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "4038282106532667627", false, false);
          }
        }

        for (int i = smaller - 1; i >= 0; i--) {
          final SNode formal = ListSequence.fromList(formals).getElement(i);
          final SNode actual = ListSequence.fromList(actuals).getElement(i);

          if (SNodeOperations.isInstanceOf(actual, CONCEPTS.IRequiresTypeToBeInferred$3C)) {
            {
              SNode _nodeToCheck_1029348928467 = actual;
              EquationInfo _info_12389875345 = new EquationInfo(_nodeToCheck_1029348928467, null, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "7270453972808948338", 0, null);
              typeCheckingContext.createLessThanInequality((SNode) typeCheckingContext.typeOf(_nodeToCheck_1029348928467, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "7270453972808948352", true), (SNode) typeCheckingContext.typeOf(formal, "r:a08f1c59-09f4-4839-91dc-89de02b086a5(ReversibleExpressions.typesystem)", "7270453972808948395", true), false, true, _info_12389875345);
            }
          }
        }
      }
    }
  }
  public SAbstractConcept getApplicableConcept() {
    return CONCEPTS.ReversibleFunctionCall$TO;
  }
  public IsApplicableStatus isApplicableAndPattern(SNode argument) {
    return new IsApplicableStatus(argument.getConcept().isSubConceptOf(getApplicableConcept()), null);
  }
  public boolean overrides() {
    return false;
  }

  private static final class LINKS {
    /*package*/ static final SContainmentLink arguments$gPkY = MetaAdapterFactory.getContainmentLink(0x5eb14d5ab5f74626L, 0xa63b80c6b9db7397L, 0x5e81f50da12f055fL, 0x4f39f90935e92f45L, "arguments");
  }

  private static final class CONCEPTS {
    /*package*/ static final SInterfaceConcept IRequiresTypeToBeInferred$3C = MetaAdapterFactory.getInterfaceConcept(0x61c69711ed614850L, 0x81d97714ff227fb0L, 0x479c34ecb3e934c3L, "com.mbeddr.core.expressions.structure.IRequiresTypeToBeInferred");
    /*package*/ static final SConcept ReversibleFunctionCall$TO = MetaAdapterFactory.getConcept(0x9abffa92487542bfL, 0x9379c4f95eb496d4L, 0x2e6ecb766f1587b4L, "ReversibleExpressions.structure.ReversibleFunctionCall");
  }
}
